#!/bin/bash
# ingestfile
# select an audiovisual file, package it, and transcode it

VERSION="1.0"
QUEUEFILE="${HOME}/Desktop/queue.txt"
SCRIPTDIR=$(dirname "${0}")
. "${SCRIPTDIR}/mmfunctions" || { echo "Missing '${SCRIPTDIR}/mmfunctions'. Exiting." ; exit 1 ;};
_initialize_make


funcDirectory() {
    DIR_VAR_NAME="${1}"
    DIR_VAR_VALUE="${!1}"
    DIR_LABEL="${2}"
    if [[ -n "${DIR_VAR_VALUE}" ]] ;
    then DIR_DEFAULT="<default>${DIR_VAR_VALUE}</default>"
    fi
    cat << GTK_PART
    <vbox>
    	<text>
    		<label>"${DIR_LABEL}"</label>
    	</text>
    	<hbox>
      		<entry accept="directory" fs-entry="Select a Directory">
          		${DIR_DEFAULT}
       	  		<variable>${DIR_VAR_NAME}</variable>
      		</entry>
      		<button>
        		<input file stock="gtk-open"></input>
         		<variable>DIRBROWSE</variable>
        		<action type="fileselect">${DIR_VAR_NAME}</action>
      		</button>
    	</hbox>
    </vbox>
GTK_PART
}

funcEntry(){
  ENTRY_VAR_NAME="${1}"
  ENTRY_VAR_VALUE="${!1}"
  ENTRY_LABEL="${2}"
  if [[ -n "${ENTRY_VAR_VALUE}" ]] ;
  then ENTRY_DEFAULT="<default>${ENTRY_VAR_VALUE}</default>"
  fi
  cat << GTK_ENTRY
<vbox>
  <text wrap="true" width-chars="60" xalign="0">
    <label>${ENTRY_LABEL}</label>
  </text>
  <entry>
    <variable>${ENTRY_VAR_NAME}</variable>
    ${ENTRY_DEFAULT}
    </entry>
</vbox>
GTK_ENTRY
}

_get_index_of_value(){
  # run with function, value to look for as first argument, and array to look in as 2nd argument, such function as
  # _get_index_of_value "${VIDEO_INPUT_CHOICE}" "${VIDEO_INPUT_OPTIONS[@]}"
  VALUE="${1}"
  shift
  LIST=( "$@" )
  INDEX=0
  MATCH=""
  for ITEM in "${LIST[@]}" ; do
    if [[ "${VALUE}" = "${ITEM}" ]] ; then
      MATCH="$INDEX"
    fi
    (( ++INDEX ))
  done
    if [[ -n "${MATCH}" ]] ; then
      echo -n "${MATCH}"
    fi
}

_expand_list2items(){
  LIST=( "$@" )
    for i in "${LIST[@]}" ; do
      echo "<item>${i}</item>"
    done
}

funcCombo(){
    VARIABLE_NAME="${1}"
    LABEL="${3}"
    shift 3
    OPTION_LIST=("${@}")
    SELECTION="$(_get_index_of_value "${!VARIABLE_NAME}" "${OPTION_LIST[@]}")"
    LIST="$(_expand_list2items "${OPTION_LIST[@]}")"
    cat << GTK_COMBO
    <hbox>
      <text>
          <label>${LABEL}</label>
      </text>
      <comboboxtext allow-empty=\"false\" value-in-list=\"true\" button-sensitivity=\"1\" focus-on-click=\"false\" selection-mode=\"1\" selected-row=\"${SELECTION}\">
          <variable>${VARIABLE_NAME}</variable>
          ${LIST}
      </comboboxtext>
    </hbox>
GTK_COMBO
}



export MAIN_DIALOG=$(cat << MAIN_FORM
	<window title="ingestfile" resizable="false" window_position="1">
		<vbox>
			<text>
				<label>Ingest file options.</label>
			</text>
			<frame>
				$(funcEntry OPERATOR "Please enter your name")
				$(funcEntry MEDIAID "Please enter a unique MEDIA ID (capital letters, numbers, hyphens and underscores only).")
				$(funcDirectory INPUT "Select your file")
			</frame>
		</vbox>
	</window>
MAIN_FORM
)

GTK_OUTPUT="$(gtkdialog --program=MAIN_DIALOG | sort)"
echo "${GTK_OUTPUT}"

